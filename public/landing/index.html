<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CitrusWindow | Decisiones agr√≠colas operativas sin riesgo</title>
    <meta
      name="description"
      content="CitrusWindow es un SaaS agr√≠cola B2B para toma de decisiones operativas cr√≠ticas: planificaci√≥n de recolecci√≥n, gesti√≥n de cosecha y reducci√≥n de riesgo operativo en cooperativas y almacenes."
    />
    <meta
      name="keywords"
      content="toma de decisiones agr√≠colas, gesti√≥n de cosecha, riesgo operativo, planificaci√≥n de recolecci√≥n, SaaS agr√≠cola B2B, cooperativas, almacenes"
    />
    <link rel="stylesheet" href="./styles.css" />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />
  </head>
  <body>
    <header class="site-header">
      <div class="container header-content">
        <div class="brand">
          CitrusWindow üçä
          <span class="brand-claim">Pensado para almacenes y cooperativas</span>
        </div>
        <div class="header-cta">Demo privada bajo solicitud</div>
      </div>
    </header>

    <main>
      <section class="hero">
        <div class="container hero-grid">
          <div class="hero-text">
            <p class="eyebrow">CitrusWindow ¬∑ SaaS agr√≠cola B2B</p>
            <h1>
              Deja de adivinar. Decide con criterio cu√°ndo recolectar la fruta.
            </h1>
            <p class="hero-lead">
              CitrusWindow es un panel de control para decidir el mejor momento
              de recolecci√≥n en las pr√≥ximas 48 horas. Disponible en versi√≥n
              premium y con posibilidad de adaptar funcionalidades a medida si
              necesitas integraciones o flujos personalizados.
            </p>
            <p class="hero-sublead">
              Tecnolog√≠a con APIs reales: Open-Meteo (precipitaci√≥n y humedad),
              RainViewer (radar) y OpenStreetMap/Nominatim (mapas y geocodificaci√≥n).
            </p>
            <div class="hero-input">
              <label for="orchard-search">Localidad o Nombre del Huerto</label>
              <div class="input-row">
                <input
                  id="orchard-search"
                  type="text"
                  placeholder="Escribe 3 letras para buscar"
                  autocomplete="off"
                />
                <button class="secondary-button" type="button" id="search-button">
                  Buscar
                </button>
              </div>
              <div class="search-results" id="search-results"></div>
              <p class="search-note" id="search-note">
                Localidad seleccionada: ‚Äî
              </p>
            </div>
            <div class="hero-actions">
              <a class="primary-button" id="cta-hero" href="#">
                Probar con mis huertos ahora
              </a>
              <span class="cta-note">7 d√≠as de prueba gratuita ¬∑ sin tarjeta</span>
            </div>
            <ul class="hero-benefits">
              <li>‚úî Predicci√≥n de ventana de carga a 48h.</li>
              <li>‚úî Monitorizaci√≥n de humedad de hoja en tiempo real.</li>
              <li>‚úî Sin hardware adicional, basado en datos satelitales y locales.</li>
            </ul>
          </div>
          <div class="hero-panel">
            <div class="panel-title">Panel de decisi√≥n</div>
            <div class="decision-widget decision-widget-large">
              <div class="widget-status">
                <span class="status-label">Sem√°foro</span>
                <span class="status-pill status-go is-active" id="status-operativo">OPERATIVO</span>
                <span class="status-pill status-stop" id="status-bloqueado">BLOQUEADO</span>
              </div>
              <div class="widget-time">
                <span class="widget-label">Ventana segura</span>
                <span class="widget-value" id="window-value">‚Äî</span>
              </div>
              <div class="widget-time">
                <span class="widget-label">Estado de suelo</span>
                <span class="widget-value" id="ground-value">‚Äî</span>
              </div>
            </div>
            <div class="panel-map">
              <div class="map-header">
                <span>Mapa de estados</span>
                <span class="map-chip" id="radar-chip">Radar activo</span>
              </div>
              <div class="map-canvas" id="radar-map"></div>
            </div>
            <div class="humidity-chart">
              <div class="chart-header">
                <span>Humedad de fruta</span>
                <span class="chart-tag" id="chart-tag">Zona cr√≠tica</span>
              </div>
              <div class="chart-body" id="chart-body">
                <svg class="chart-svg" viewBox="0 0 300 140" preserveAspectRatio="none">
                  <path id="chart-area" class="chart-area" d="" />
                  <polyline id="chart-line" class="chart-line" points="" />
                  <polyline id="rain-line" class="rain-line" points="" />
                </svg>
                <div class="chart-zone" id="chart-zone">ZONA DE CORTE PROHIBIDO</div>
                <div class="chart-meta" id="chart-meta">Humedad actual: ‚Äî</div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section class="section" id="coste-incertidumbre">
        <div class="container">
          <div class="section-header">
            <span class="section-kicker">El coste de la incertidumbre</span>
            <h2>Cuando no hay criterio, la log√≠stica se rompe</h2>
          </div>
          <div class="grid-3">
            <div class="card">
              <div class="card-icon">
                <svg viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M8 4.5a2 2 0 0 1 1.8 1.1l1 2a2 2 0 0 1-.3 2.3l-1.3 1.3a12.5 12.5 0 0 0 5.3 5.3l1.3-1.3a2 2 0 0 1 2.3-.3l2 1a2 2 0 0 1 1.1 1.8V20a2 2 0 0 1-2 2h-1C8.8 22 2 15.2 2 6V5a2 2 0 0 1 2-2h4Z" />
                  <path d="M16 5c1.3.7 2.3 1.7 3 3" />
                  <path d="M17.5 2.5c2 1 3.5 2.5 4.5 4.5" />
                </svg>
              </div>
              <h3>Llamadas interminables</h3>
              <p>
                Llamadas interminables a responsables de campo para confirmar si
                llueve en la otra punta de la provincia.
              </p>
            </div>
            <div class="card">
              <div class="card-icon">
                <svg viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M10 17h4a3 3 0 0 0 6 0h1v-5.5a2 2 0 0 0-2-2H16V7a2 2 0 0 0-2-2H3v10a2 2 0 0 0 2 2h2a3 3 0 0 0 3 0Z" />
                  <path d="M16 7h3l2 3.5" />
                  <path d="M7 17a3 3 0 1 0 0 0" />
                  <path d="M17 17a3 3 0 1 0 0 0" />
                  <path d="M18.5 2.5c1.6 1.2 2.5 2.8 2.5 4.5" />
                </svg>
              </div>
              <h3>Camiones parados</h3>
              <p>
                Camiones parados y jornales pagados en huertos donde la fruta
                sigue mojada.
              </p>
            </div>
            <div class="card">
              <div class="card-icon">
                <svg viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M8 3h6l4 4v14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2Z" />
                  <path d="M14 3v5h5" />
                  <path d="M12 10v5" />
                  <path d="M12 18h0" />
                </svg>
              </div>
              <h3>Reclamaciones en destino</h3>
              <p>
                Riesgo de reclamaciones en destino por confeccionar fruta con
                humedad excesiva.
              </p>
            </div>
          </div>
          <p class="section-note">
            Pensado para quienes gestionan muchos huertos y no pueden permitirse
            fallar.
          </p>
        </div>
      </section>

      <section class="section alt" id="funcionalidad">
        <div class="container">
          <div class="section-header">
            <span class="section-kicker">Pensado para almacenes y cooperativas</span>
            <h2>Planes CitrusWindow</h2>
          </div>
          <div class="grid-2 plans-grid">
            <div class="card plan-card">
              <h3>Plan Profesional</h3>
              <p class="plan-meta">
                Foco: decisi√≥n t√©cnica a pie de campo.
              </p>
              <p class="plan-copy">
                Ventanas de secado claras y estado operativo por parcela en
                minutos.
              </p>
              <ul class="list plan-features">
                <li>Sem√°foro operativo actualizado cada hora.</li>
                <li>Mapa de estados para decidir cuadrillas y rutas.</li>
                <li>Alertas tempranas de humedad cr√≠tica.</li>
              </ul>
              <div class="plan-actions">
                <a class="primary-button" id="cta-plan-pro" href="#">
                  Solicitar Acceso
                </a>
              </div>
            </div>
            <div class="card plan-card emphasize">
              <span class="plan-badge">Recomendado</span>
              <h3>Plan Log√≠stica Almac√©n</h3>
              <p class="plan-meta">
                Foco: inteligencia operativa y eficiencia de flotas. Incluye
                previsi√≥n de carga a 48h (ventana de carga segura).
              </p>
              <ul class="list plan-features">
                <li>Previsi√≥n de carga a 48h (ventana de carga segura).</li>
                <li>Gesti√≥n centralizada de huertos ilimitados.</li>
                <li>Algoritmo de secado basado en balance h√≠drico real.</li>
                <li>Alertas de transitabilidad de terreno (Barro/Seco).</li>
              </ul>
              <div class="plan-actions">
                <a class="primary-button" id="cta-plan-logistica" href="#">
                  Solicitar Demo
                </a>
              </div>
            </div>
          </div>
          <p class="section-note">
            Precio adaptado seg√∫n necesidades. Configuramos el sistema seg√∫n el
            volumen de tus huertos y el tama√±o de tu flota.
          </p>
        </div>
      </section>

      <section class="section" id="comparativa">
        <div class="container">
          <div class="section-header">
            <span class="section-kicker">Tabla comparativa de valor</span>
            <h2>App del tiempo vs CitrusWindow</h2>
          </div>
          <div class="compare-table">
            <div class="compare-row compare-head">
              <div></div>
              <div>App del tiempo (Gratis)</div>
              <div>CitrusWindow (SaaS)</div>
            </div>
            <div class="compare-row">
              <div>Conoce tu fruta</div>
              <div>No conoce tu fruta.</div>
              <div>Te dice si la naranja est√° seca para ser encajada.</div>
            </div>
            <div class="compare-row">
              <div>Secado</div>
              <div>No predice el secado.</div>
              <div>Calcula ventanas de carga.</div>
            </div>
            <div class="compare-row">
              <div>Gesti√≥n de huertos</div>
              <div>Te dice si llueve.</div>
              <div>Guarda tus 50+ huertos.</div>
            </div>
          </div>
          <p class="compare-note">
            Un solo error de recolecci√≥n cuesta m√°s que un mes de la herramienta.
          </p>
        </div>
      </section>

      <section class="section alt" id="cta">
        <div class="container cta">
          <h2>Menos viajes fallidos. M√°s jornales bien empleados.</h2>
          <p>
            CitrusWindow alinea cuadrillas, camiones y almac√©n con una decisi√≥n
            operativa clara por huerto.
          </p>
          <div class="cta-actions">
            <a class="primary-button" id="cta-footer" href="#">
              Probar con mis huertos ahora
            </a>
          </div>
        </div>
      </section>

    </main>

    <footer class="site-footer">
      <div class="container">
        <div class="trust-badge">
          <span class="trust-title">Tecnolog√≠a respaldada por datos reales</span>
          <div class="trust-logos">
            <span>OPEN-METEO</span>
            <span>RAINVIEWER</span>
            <span>OPENSTREETMAP</span>
          </div>
        </div>
        <p>
          No es una app del tiempo. Es un modelo agron√≥mico basado en balance
          h√≠drico espec√≠fico para c√≠tricos.
        </p>
        <p>
          No nos hacemos responsables de errores de predicci√≥n. Tecnolog√≠a
          basada en APIs de terceros que pueden fallar.
        </p>
        <p>
          <a href="https://www.lindinformatica.com" title="https://www.lindinformatica.com">www.lindinformatica.com</a>
          ¬∑ Almassora (Castell√≥) ¬∑ +34 689 388 980
        </p>
      </div>
    </footer>
    <a
      class="whatsapp-button"
      href="https://wa.me/34689388980?text=%C2%BFDudas%20t%C3%A9cnicas%3F%20Necesito%20informaci%C3%B3n%20sobre%20CitrusWindow."
      target="_blank"
      rel="noreferrer"
    >
      <span class="whatsapp-icon">WA</span>
      ¬øDudas t√©cnicas? Habla con un experto
    </a>
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>
    <script>
      const saasUrl = window.location.origin;
      document.getElementById("cta-hero").href = saasUrl;
      document.getElementById("cta-footer").href = saasUrl;
      document.getElementById("cta-plan-pro").href = saasUrl;
      document.getElementById("cta-plan-logistica").href =
        "https://wa.me/34689388980?text=%C2%BFDudas%20t%C3%A9cnicas%3F%20Necesito%20una%20demo%20de%20CitrusWindow.";

      const trackLandingVisit = () => {
        const payload = {
          path: window.location.pathname,
          referrer: document.referrer || "",
          userAgent: navigator.userAgent || "",
        };
        const body = JSON.stringify(payload);
        if (navigator.sendBeacon) {
          const blob = new Blob([body], { type: "application/json" });
          navigator.sendBeacon("/.netlify/functions/log-landing-visit", blob);
        } else {
          fetch("/.netlify/functions/log-landing-visit", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body,
            keepalive: true,
          }).catch(() => {});
        }
      };
      trackLandingVisit();

      const searchInput = document.getElementById("orchard-search");
      const resultsBox = document.getElementById("search-results");
      const searchNote = document.getElementById("search-note");
      const searchButton = document.getElementById("search-button");
      const statusOperativo = document.getElementById("status-operativo");
      const statusBloqueado = document.getElementById("status-bloqueado");
      const windowValue = document.getElementById("window-value");
      const groundValue = document.getElementById("ground-value");
      const chartTag = document.getElementById("chart-tag");
      const chartZone = document.getElementById("chart-zone");
      const chartBody = document.getElementById("chart-body");
      const chartLine = document.getElementById("chart-line");
      const rainLine = document.getElementById("rain-line");
      const chartArea = document.getElementById("chart-area");
      const chartMeta = document.getElementById("chart-meta");
      const radarChip = document.getElementById("radar-chip");
      let searchTimer;
      const defaultCoords = { lat: 40.2, lon: -3.5 };
      const defaultZoom = 5;
      const fallbackCoords = { lat: 39.943, lon: -0.063 };

      const setStatus = ({ isOperative, windowText, groundText }) => {
        statusOperativo.classList.toggle("is-active", isOperative);
        statusBloqueado.classList.toggle("is-active", !isOperative);
        windowValue.textContent = windowText;
        groundValue.textContent = groundText;
        chartTag.textContent = isOperative ? "Zona segura" : "Zona cr√≠tica";
        chartZone.textContent = isOperative
          ? "VENTANA SEGURA ABIERTA"
          : "ZONA DE CORTE PROHIBIDO";
        chartZone.classList.toggle("zone-safe", isOperative);
        chartBody.classList.toggle("chart-safe", isOperative);
        chartLine.classList.toggle("line-safe", isOperative);
        chartArea.classList.toggle("area-safe", isOperative);
      };

      const formatHour = (date) =>
        date.toLocaleTimeString("es-ES", { hour: "2-digit", minute: "2-digit" });

      const findWindow = (times, precipitation, humidity) => {
        const now = new Date();
        const nextHours = times
          .map((time, idx) => ({
            time: new Date(time),
            precipitation: precipitation[idx],
            humidity: humidity[idx],
          }))
          .filter((item) => item.time >= now)
          .slice(0, 12);

        let startIndex = -1;
        for (let i = 0; i < nextHours.length; i++) {
          const safe =
            nextHours[i].precipitation <= 0.1 && nextHours[i].humidity <= 85;
          if (safe && startIndex === -1) startIndex = i;
          if (!safe && startIndex !== -1) {
            const duration = i - startIndex;
            if (duration >= 3) {
              return { start: nextHours[startIndex], end: nextHours[i - 1] };
            }
            startIndex = -1;
          }
        }
        if (startIndex !== -1 && nextHours.length - startIndex >= 3) {
          return {
            start: nextHours[startIndex],
            end: nextHours[nextHours.length - 1],
          };
        }
        return null;
      };

      const buildChart = (humidityValues, rainValues) => {
        const points = humidityValues
          .map((value, index) => {
            const x = (index / (humidityValues.length - 1)) * 300;
            const y = 140 - (Math.min(100, Math.max(0, value)) / 100) * 120 - 10;
            return `${x.toFixed(1)},${y.toFixed(1)}`;
          })
          .join(" ");
        const areaPath = `${points} 300,140 0,140`;
        chartLine.setAttribute("points", points);
        chartArea.setAttribute("d", `M ${areaPath}`);

        const maxRain = Math.max(0.1, ...rainValues);
        const rainPoints = rainValues
          .map((value, index) => {
            const x = (index / (rainValues.length - 1)) * 300;
            const normalized = Math.min(maxRain, Math.max(0, value)) / maxRain;
            const y = 140 - normalized * 90 - 20;
            return `${x.toFixed(1)},${y.toFixed(1)}`;
          })
          .join(" ");
        rainLine.setAttribute("points", rainPoints);
      };

      const updateForecast = async (lat, lon) => {
        try {
          const response = await fetch(
            `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=precipitation,relativehumidity_2m&forecast_days=2&timezone=auto`
          );
          if (!response.ok) throw new Error("forecast");
          const data = await response.json();
          const humiditySeries = data.hourly.relativehumidity_2m.slice(0, 12);
          const rainSeries = data.hourly.precipitation.slice(0, 12);
          buildChart(humiditySeries, rainSeries);
          chartMeta.textContent = `Humedad actual: ${humiditySeries[0]}% ¬∑ Lluvia pr√≥xima 12h: ${rainSeries
            .reduce((sum, value) => sum + value, 0)
            .toFixed(1)} mm`;
          const window = findWindow(
            data.hourly.time,
            data.hourly.precipitation,
            data.hourly.relativehumidity_2m
          );
          if (window) {
            setStatus({
              isOperative: true,
              windowText: `${formatHour(window.start.time)} - ${formatHour(
                window.end.time
              )}`,
              groundText: "Seco y transitable",
            });
          } else {
            setStatus({
              isOperative: false,
              windowText: "Sin ventana segura en 12h",
              groundText: "H√∫medo o barro",
            });
          }
        } catch (error) {
          chartLine.setAttribute("points", "");
          chartArea.setAttribute("d", "");
          rainLine.setAttribute("points", "");
          chartMeta.textContent = "Humedad actual: sin datos";
          setStatus({
            isOperative: false,
            windowText: "Sin datos disponibles",
            groundText: "Revisi√≥n manual necesaria",
          });
        }
      };

      let mapInstance;
      let radarLayer;
      let marker;
      let markerIcon;

      const loadRadarLayer = async () => {
        try {
          const response = await fetch(
            "https://tilecache.rainviewer.com/api/maps.json"
          );
          const data = await response.json();
          const radarTimestamp = data[data.length - 1];
          radarChip.textContent = "Radar activo";
          return L.tileLayer(
            `https://tilecache.rainviewer.com/v2/radar/${radarTimestamp}/256/{z}/{x}/{y}/2/1_1.png`,
            { opacity: 0.6, zIndex: 3 }
          );
        } catch (error) {
          radarChip.textContent = "Radar no disponible";
          return null;
        }
      };

      const initMap = async (lat, lon, zoom = defaultZoom) => {
        if (!mapInstance) {
          mapInstance = L.map("radar-map", {
            zoomControl: false,
            attributionControl: false,
          }).setView([lat, lon], zoom);
          L.tileLayer(
            "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
            { opacity: 0.9 }
          ).addTo(mapInstance);
          markerIcon = L.icon({
            iconUrl:
              "https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png",
            shadowUrl:
              "https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png",
            iconSize: [25, 41],
            iconAnchor: [12, 41],
          });
          marker = L.marker([lat, lon], { icon: markerIcon }).addTo(mapInstance);
          radarLayer = await loadRadarLayer();
          if (radarLayer) {
            radarLayer.addTo(mapInstance);
          }
          setTimeout(() => mapInstance.invalidateSize(), 0);
        } else {
          mapInstance.setView([lat, lon], zoom);
          marker.setLatLng([lat, lon]);
          if (radarLayer) {
            mapInstance.removeLayer(radarLayer);
          }
          radarLayer = await loadRadarLayer();
          if (radarLayer) {
            radarLayer.addTo(mapInstance);
          }
          mapInstance.invalidateSize();
        }
      };

      const clearResults = () => {
        resultsBox.innerHTML = "";
        resultsBox.style.display = "none";
      };

      const renderResults = (items) => {
        if (!items.length) {
          clearResults();
          return;
        }
        resultsBox.innerHTML = items
          .map(
            (item) =>
              `<button type="button" data-name="${item.display_name}" data-lat="${item.lat}" data-lon="${item.lon}">${item.display_name}</button>`
          )
          .join("");
        resultsBox.style.display = "grid";
      };

      const fetchLocations = async (query) => {
        const response = await fetch(
          `https://nominatim.openstreetmap.org/search?format=json&limit=5&accept-language=es&q=${encodeURIComponent(
            query
          )}`
        );
        if (!response.ok) return [];
        return response.json();
      };

      const setMarkerPosition = (lat, lon) => {
        if (marker) {
          marker.setLatLng([lat, lon]);
        }
      };

      const setMarkerFromFallback = () => {
        setMarkerPosition(fallbackCoords.lat, fallbackCoords.lon);
      };

      const setInitialMarker = () => {
        if (!navigator.geolocation) {
          setMarkerFromFallback();
          return;
        }
        navigator.geolocation.getCurrentPosition(
          (position) => {
            setMarkerPosition(position.coords.latitude, position.coords.longitude);
          },
          () => {
            setMarkerFromFallback();
          },
          { enableHighAccuracy: true, timeout: 8000 }
        );
      };

      searchInput.addEventListener("input", () => {
        const query = searchInput.value.trim();
        if (query.length < 3) {
          clearResults();
          return;
        }
        clearTimeout(searchTimer);
        searchTimer = setTimeout(async () => {
          const items = await fetchLocations(query);
          renderResults(items);
        }, 350);
      });

      resultsBox.addEventListener("click", (event) => {
        const button = event.target.closest("button");
        if (!button) return;
        const selection = button.getAttribute("data-name");
        const lat = Number(button.getAttribute("data-lat"));
        const lon = Number(button.getAttribute("data-lon"));
        searchInput.value = selection;
        searchNote.textContent = `Localidad seleccionada: ${selection}`;
        clearResults();
        initMap(lat, lon);
        updateForecast(lat, lon);
      });

      searchButton.addEventListener("click", async () => {
        const query = searchInput.value.trim();
        if (query.length < 3) return;
        const items = await fetchLocations(query);
        renderResults(items);
        if (items[0]) {
          const selection = items[0].display_name;
          const lat = Number(items[0].lat);
          const lon = Number(items[0].lon);
          searchNote.textContent = `Localidad seleccionada: ${selection}`;
          initMap(lat, lon);
          updateForecast(lat, lon);
        }
      });

      searchInput.addEventListener("keydown", (event) => {
        if (event.key === "Enter") {
          event.preventDefault();
          searchButton.click();
        }
      });

      initMap(defaultCoords.lat, defaultCoords.lon, defaultZoom);
      setInitialMarker();
      setStatus({
        isOperative: false,
        windowText: "Selecciona una localidad",
        groundText: "Pendiente de an√°lisis",
      });

      document.addEventListener("click", (event) => {
        if (!resultsBox.contains(event.target) && event.target !== searchInput) {
          clearResults();
        }
      });

    </script>
  </body>
</html>
